name: Sync Staging â†’ Production

on:
  workflow_dispatch:     # âœ… Run manually from the Actions tab
  push:
    branches:
      - main             # Optional: auto-run when you push to main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------
      # âœ… Checkout code
      # --------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # --------------------------------------------
      # âœ… Setup Node.js
      # --------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # --------------------------------------------
      # âœ… Install Supabase CLI locally
      # --------------------------------------------
      - name: Install Supabase CLI
        run: npm install supabase --save-dev

      # --------------------------------------------
      # âœ… Verify CLI installation
      # --------------------------------------------
      - name: Verify Supabase CLI
        run: npx supabase --version
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # --------------------------------------------
      # âœ… Link to Staging and dump schema
      # --------------------------------------------
      - name: Export schema from Staging
        run: |
          echo "ðŸ”¹ Linking to Staging project..."
          npx supabase link --project-ref ${{ vars.STAGING_REF }}
          echo "ðŸ”¹ Dumping schema from Staging..."
          npx supabase db dump --data false --file staging_schema.sql
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # --------------------------------------------
      # âœ… Pull latest functions from Staging
      # --------------------------------------------
      - name: Pull functions from Staging
        run: |
          echo "ðŸ”¹ Pulling functions from Staging..."
          npx supabase functions pull
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # --------------------------------------------
      # âœ… Link to Production
      # --------------------------------------------
      - name: Link to Production
        run: |
          echo "ðŸ”¹ Linking to Production project..."
          npx supabase link --project-ref ${{ vars.PROD_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # --------------------------------------------
      # âœ… Apply schema from Staging â†’ Production
      # (This safely syncs DB structure without migration issues)
      # --------------------------------------------
      - name: Push schema to Production
        run: |
          echo "ðŸ”¹ Applying schema to Production..."
          npx supabase db push --file staging_schema.sql
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # --------------------------------------------
      # âœ… Deploy functions to Production
      # --------------------------------------------
      - name: Deploy Supabase Functions
        run: |
          echo "ðŸ”¹ Deploying functions to Production..."
          npx supabase functions deploy
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # --------------------------------------------
      # âœ… Cleanup (optional)
      # --------------------------------------------
      - name: Cleanup temp files
        run: rm -f staging_schema.sql
